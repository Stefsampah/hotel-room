<div class="room-details">
  <div class="room-info-section">
    <h1><%= @hotel.name %></h1>
    
    <div class="room-images">
      <% if @room.main_image.attached? %>
        <%= image_tag @room.main_image, class: "main-image" %>
      <% end %>
      
      <div class="gallery-images">
        <% @room.gallery_images.each do |image| %>
          <%= image_tag image, class: "gallery-image" %>
        <% end %>
      </div>
    </div>

    <div class="room-description">
      <p><%= @hotel.description %></p>
      <h3>À propos de cette chambre</h3>
      <ul>
        <li>Type: <%= @room.room_type %></li>
        <li>Prix: <%= number_to_currency(@room.price) %> / nuit</li>
        <li>Localisation: <%= @hotel.address %></li>
      </ul>
    </div>
  </div>

  <div class="booking-section">
    <div class="booking-form">
      <h2>Votre réservation</h2>
      
      <% if flash[:alert] %>
        <div class="alert alert-danger">
          <%= flash[:alert] %>
        </div>
      <% end %>
      
      <%= form_for [@hotel, @room, @booking], url: hotel_room_bookings_path(@hotel, @room) do |f| %>
        <div class="form-group">
          <%= f.label :start_date, "Date d'arrivée *" %>
          <%= f.date_field :start_date, class: "form-control",
              required: true,
              data: {
                controller: "flatpickr",
                action: "change->availability#checkAvailability"
              } %>
        </div>

        <div class="form-group">
          <%= f.label :end_date, "Date de départ *" %>
          <%= f.date_field :end_date, class: "form-control",
              required: true,
              data: {
                controller: "flatpickr",
                action: "change->availability#checkAvailability"
              } %>
        </div>

        <div id="availability-message"></div>
        <div class="total-price">
          <p>Total: <span id="total-price">--</span></p>
        </div>

        <%= f.submit "Réserver maintenant", class: "book-button",
            data: { 
              controller: "availability",
              action: "click->availability#validateBooking"
            } %>
      <% end %>
    </div>
  </div>
</div>

<%= content_for :scripts do %>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const calculateTotal = () => {
        const startDate = new Date(document.getElementById("booking_start_date").value);
        const endDate = new Date(document.getElementById("booking_end_date").value);
        const pricePerNight = <%= @room.price %>;
        
        if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
          const nights = (endDate - startDate) / (1000 * 60 * 60 * 24);
          if (nights > 0) {
            const total = nights * pricePerNight;
            document.getElementById("total-price").textContent = new Intl.NumberFormat('fr-FR', {
              style: 'currency',
              currency: 'EUR'
            }).format(total);
          } else {
            document.getElementById("total-price").textContent = "--";
          }
        } else {
          document.getElementById("total-price").textContent = "--";
        }
      };

      document.getElementById("booking_start_date").addEventListener("change", calculateTotal);
      document.getElementById("booking_end_date").addEventListener("change", calculateTotal);
    });
  </script>
<% end %>

<% content_for :styles do %>
  <style>
    .alert {
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }

    .alert-danger {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .form-group label::after {
      content: " *";
      color: #dc3545;
    }
  </style>
<% end %>
